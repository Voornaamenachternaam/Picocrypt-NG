name: golangci-lint

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: write
  pull-requests: write
  checks: write

env:
  SRC_DIR: src
  LINT_TIMEOUT: 5m
  GOFLAGS: "-mod=mod"
  CGO_ENABLED: 0

jobs:
  linter:
    name: golangci-lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Locate go.mod
        id: locate
        run: |
          if [ -f "${{ env.SRC_DIR }}/go.mod" ]; then
            echo "path=${{ env.SRC_DIR }}" >> $GITHUB_OUTPUT
          elif [ -f "go.mod" ]; then
            echo "path=." >> $GITHUB_OUTPUT
          else
            echo "No go.mod found in repository root or ${SRC_DIR}" >&2
            exit 1
          fi

      - name: Detect Go version
        id: goversion
        run: |
          MODPATH="${{ steps.locate.outputs.path }}"
          VERSION=$(awk '/^go /{print $2; exit}' "$MODPATH/go.mod" || true)
          if [ -z "$VERSION" ]; then
            echo "go-version=stable" >> $GITHUB_OUTPUT
          else
            echo "go-version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ steps.goversion.outputs.go-version }}

      - name: Ensure git user for automated commits
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Prune and download modules
        working-directory: ${{ steps.locate.outputs.path }}
        run: |
          set -e
          go env
          go mod tidy

      - name: Install golangci-lint
        run: |
          set -e
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b "$(go env GOPATH 2>/dev/null || echo $HOME/go)/bin" v1.59.0
          export PATH="$(go env GOPATH 2>/dev/null || echo $HOME/go)/bin:$PATH"
          which golangci-lint
          golangci-lint --version

      - name: Run golangci-lint with autofix
        id: lint
        working-directory: ${{ steps.locate.outputs.path }}
        env:
          PATH: ${{ runner.temp }}/go/bin:${{ env.PATH }}
        run: |
          set -o pipefail
          export PATH="$(go env GOPATH 2>/dev/null || echo $HOME/go)/bin:$PATH"
          golangci-lint run --fix --timeout=${{ env.LINT_TIMEOUT }} ./... | tee ../golangci-fix.log || true

      - name: Generate lint summary
        id: summary
        working-directory: ${{ steps.locate.outputs.path }}
        run: |
          set +e
          export PATH="$(go env GOPATH 2>/dev/null || echo $HOME/go)/bin:$PATH"
          golangci-lint run --out-format=tab --timeout=${{ env.LINT_TIMEOUT }} ./... > ../lint-summary.txt 2>&1 || true
          ISSUES_TOTAL=$(awk 'NF{count++} END{print count+0}' ../lint-summary.txt || echo 0)
          FIXED=$(git --no-pager diff --name-only | grep '\.go$' | wc -l | tr -d ' ' || echo 0)
          echo "issues_total=$ISSUES_TOTAL" >> $GITHUB_OUTPUT
          echo "fixed=$FIXED" >> $GITHUB_OUTPUT
          set -e

      - name: Detect repository changes after autofix
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request for autofixes
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.GH2_TOKEN }}
          title: "chore: apply golangci-lint autofixes"
          commit-message: "chore: apply golangci-lint autofixes"
          branch: lint-fixes/${{ github.sha }}
          body: |
            This pull request contains automatic code fixes generated by golangci-lint.

            Summary
            - Fixes applied: ${{ steps.summary.outputs.fixed }}
            - Remaining issues: ${{ steps.summary.outputs.issues_total }}
          base: main
          add-paths: |
            ${{ steps.locate.outputs.path }}/**/*.go
          labels: |
            automated
            lint

      - name: Comment lint summary on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GH2_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            golangci-lint report
            - Fixes applied: ${{ steps.summary.outputs.fixed }}
            - Remaining issues: ${{ steps.summary.outputs.issues_total }}
            Attached: lint-summary.txt and golangci-fix.log

      - name: Run tests (non-blocking)
        working-directory: ${{ steps.locate.outputs.path }}
        continue-on-error: true
        run: |
          set -o pipefail
          go test -v -cover ./... 2>&1 | tee ../test-log.txt || true

      - name: Build (non-blocking)
        working-directory: ${{ steps.locate.outputs.path }}
        continue-on-error: true
        run: |
          set -e
          go build -v -ldflags "-s -w" -trimpath ./... 2>&1 | tee ../build-log.txt || true

      - name: Upload logs and lint report
        uses: actions/upload-artifact@v4.6.2
        with:
          name: golangci-lint-logs
          path: |
            lint-summary.txt
            golangci-fix.log
            test-log.txt
            build-log.txt
