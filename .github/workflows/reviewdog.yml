name: reviewdog

permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  id-token: write
  issues: write
  discussions: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'
  push:
    tags:
      - 'v*'

jobs:
  lint-and-upload:
    name: golangci-lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Ensure reports dir exists
        run: mkdir -p reports

      - name: Detect Go module root and target file
        id: find-go-module
        run: |
          module_file=$(find . -maxdepth 6 -type f -name go.mod -print -quit || true)
          target_file=$(find . -type f -path './src/Picocrypt-NG.go' -print -quit || true)
          if [ -z "$target_file" ]; then
            target_file=$(find . -type f -name 'Picocrypt-NG.go' -print -quit || true)
          fi

          if [ -z "$module_file" ]; then
            module_dir="."
          else
            module_dir=$(dirname "$module_file")
            module_dir=${module_dir#./}
            if [ -z "$module_dir" ]; then module_dir="."; fi
          fi

          if [ -z "$target_file" ]; then
            target_rel="src/Picocrypt-NG.go"
          else
            target_file=${target_file#./}
            if [ "$module_dir" = "." ]; then
              target_rel="$target_file"
            else
              prefix="${module_dir%/}/"
              case "$target_file" in
                "$prefix"*) target_rel="${target_file#$prefix}" ;;
                *) target_rel="$target_file" ;;
              esac
            fi
          fi

          echo "module-root=$module_dir" >> $GITHUB_OUTPUT
          echo "target-path=$target_rel" >> $GITHUB_OUTPUT

      - name: Install system packages required by GTK/GLFW
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            build-essential \
            libgtk-3-dev \
            libx11-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxi-dev \
            libxinerama-dev \
            libxss-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev
          pkg-config --modversion gtk+-3.0 || true

      - name: Run golangci-lint (via reviewdog action) for single file
        uses: reviewdog/action-golangci-lint@v2.8.0
        with:
          golangci_lint_flags: '--fix --output.sarif.path=reports/golangci.sarif --output.text.path=stdout ${{ steps.find-go-module.outputs.target-path }}'
          reporter: github-pr-check
          cache: false
          level: error
          workdir: ${{ steps.find-go-module.outputs.module-root }}
        env:
          CGO_ENABLED: '1'
          PKG_CONFIG_PATH: ''

      - name: Ensure SARIF exists for Code Scanning upload
        if: always()
        run: |
          if [ ! -s reports/golangci.sarif ]; then
            echo '{' > reports/golangci.sarif
            echo '  "version": "2.1.0",' >> reports/golangci.sarif
            echo '  "$schema": "https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0-rtm.5.json",' >> reports/golangci.sarif
            echo '  "runs": [' >> reports/golangci.sarif
            echo '    {' >> reports/golangci.sarif
            echo '      "tool": {' >> reports/golangci.sarif
            echo '        "driver": {' >> reports/golangci.sarif
            echo '          "name": "golangci-lint",' >> reports/golangci.sarif
            echo '          "informationUri": "https://github.com/golangci/golangci-lint"' >> reports/golangci.sarif
            echo '        }' >> reports/golangci.sarif
            echo '      },' >> reports/golangci.sarif
            echo '      "results": []' >> reports/golangci.sarif
            echo '    }' >> reports/golangci.sarif
            echo '  ]' >> reports/golangci.sarif
            echo '}' >> reports/golangci.sarif
          fi

      - name: Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/golangci.sarif
          wait-for-processing: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove SARIF report before PR creation
        if: always()
        run: rm -rf reports

      - name: Create Pull Request with Fixes
        uses: peter-evans/create-pull-request@v7.0.11
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix golangci-lint issues"
          title: "chore: auto-fix golangci-lint issues"
          body: "Automated fixes applied by golangci-lint."
          branch: "fix/golangci-lint-auto-fixes"
          base: "main"
